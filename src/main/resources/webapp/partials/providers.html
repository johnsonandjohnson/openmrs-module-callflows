<div class="row">
    <h4 class="frame-title">{{msg('callflows.tab.providers')}}</h4>
</div>

<div class="alert alert-danger alert-block" ng-show="configs.length <= 0">
    {{msg('callflows.error.noConfig')}}
</div>

<div ng-show="errors.length > 0">
    <div class="alert alert-error alert-block" ng-repeat="error in errors" ng-cloak>
        {{error}}
    </div>
</div>

<div ng-repeat="message in messages" class="alert alert-success alert-block animate-repeat">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    {{message}}
</div>

<div class="form-group">
    <button type="button" class="btn btn-success" ng-click="addConfig();"><i class="icon-plus icon-white"></i>
        {{msg('callflows.btn.addConfig')}}
    </button>
</div>

<form name="form" class="form-horizontal inside" novalidate>
    <div class="row">
        <div class="panel-group">
            <div class="panel panel-default ivr-config" ng-repeat="conf in configs">
                <div class="panel-heading" ng-click="accordions[$index] = !accordions[$index]">
                    {{conf.name}}
                    <i ng-class="{'icon-chevron-down': accordions[$index], 'icon-chevron-right': !accordions[$index]}"
                       class="icon-fixed-width icon-large pointer"></i>
                </div>
                <div id="panel{{$index}}" class="panel-collapse collapse"
                     ng-class="{true:'in', false:''}[accordions[$index]]">

                    <div class="form-group margin-before2" ng-class="{'has-error': !conf.name || dupeNames[$index]}">
                        <label class="col-md-3 control-label">{{msg('callflows.field.configName')}}</label>

                        <div class="col-md-3" data-toggle="tooltip" data-placement="top" data-trigger="hover"
                             bs-popover="{{msg('callflows.field.configName.tooltip')}}">
                            <input type="text" class="form-control" ng-model="conf.name" required
                                   ng-focus="accordions[$index]"
                                   ng-change="keepDefaultConfig(); checkForDuplicateNames($index);">
                            <span ng-hide="conf.name" class="form-hint form-hint-bottom">{{msg('callflows.error.required')}}</span>
                            <span ng-show="dupeNames[$index]" class="form-hint form-hint-bottom">{{msg('callflows.error.config.not-unique')}}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label" for="outgoingCallUriTemplate{{$index}}">{{msg('callflows.field.outgoingCallUriTemplate')}}</label>

                        <div class="col-md-8" data-toggle="tooltip" data-placement="top" data-trigger="hover"
                             data-html="true"
                             bs-popover="{{msg('callflows.field.outgoingCallUriTemplate.tooltip')}}">
                            <textarea spellcheck="false" class="form-control" id="outgoingCallUriTemplate{{$index}}"
                                      type="text" ng-model="conf.outgoingCallUriTemplate" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label">{{msg('callflows.field.outgoingCallMethod')}}</label>

                        <div class="col-md-3" data-toggle="tooltip" data-placement="top" data-trigger="hover"
                             bs-popover="{{msg('callflows.field.outgoingCallMethod.tooltip')}}">
                            <label class="radio-inline" for="outgoingCallMethodGet{{$index}}">
                                <input name="outgoingCallMethod{{$index}}" id="outgoingCallMethodGet{{$index}}"
                                       type="radio" ng-model="conf.outgoingCallMethod" value="GET">
                                GET
                            </label>
                            <label class="radio-inline" for="outgoingCallMethodPost{{$index}}">
                                <input name="outgoingCallMethod{{$index}}" id="outgoingCallMethodPost{{$index}}"
                                       type="radio" ng-model="conf.outgoingCallMethod" value="POST">
                                POST
                            </label>
                        </div>
                    </div>

                    <div class="form-group" ng-show="conf.outgoingCallMethod == 'POST'">
                        <label class="col-md-3 control-label" for="outgoingCallPostHeadersMap{{$index}}">{{msg('callflows.field.outgoingCallPostHeaders')}}</label>

                        <div class="col-md-8" data-toggle="tooltip" data-placement="top" data-trigger="hover"
                             data-html="true"
                             bs-popover="{{msg('callflows.field.outgoingCallPostHeaders.tooltip')}}">
                            <ng-form name="outgoingCallPostHeadersMap{{$index}}">
                                <textarea spellcheck="false" class="form-control"
                                          id="outgoingCallPostHeadersMap{{$index}}"
                                          name="outgoingCallPostHeaders"
                                          rows="3"
                                          ng-model="conf.outgoingCallPostHeadersMapString">
                                </textarea>
                                <span class="form-hint form-hint-bottom"
                                      ng-show="outgoingCallPostHeadersMap{{$index}}.outgoingCallPostHeaders.$dirty && outgoingCallPostHeadersMap{{$index}}.outgoingCallPostHeaders.$error.pattern">{{msg('callflows.error.badOutgoingCallPostHeaders')}}</span>
                            </ng-form>
                        </div>
                    </div>

                    <div class="form-group" ng-show="conf.outgoingCallMethod == 'POST'">
                        <label class="col-md-3 control-label" for="outgoingCallPostParams{{$index}}">{{msg('callflows.field.outgoingCallPostParams')}}</label>

                        <div class="col-md-8" data-toggle="tooltip" data-placement="top" data-trigger="hover"
                             data-html="true"
                             bs-popover="{{msg('callflows.field.outgoingCallPostParams.tooltip')}}">
                            <textarea spellcheck="false" class="form-control" id="outgoingCallPostParams{{$index}}"
                                      type="text" ng-model="conf.outgoingCallPostParams" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label">{{msg('callflows.field.outboundQueue')}}</label>

                        <div class="col-md-8">
                            <div class="row form-horizontal">
                                <div class="col-md-3 control-label">
                                    <label>{{msg('callflows.field.callLimit')}}</label>
                                </div>
                                <div class="col-md-3 control-label">
                                    <label>{{msg('callflows.field.retrySeconds')}}</label>
                                </div>
                                <div class="col-md-4 control-label">
                                    <label>{{msg('callflows.field.retryAttempts')}}</label>
                                </div>
                                <div class="col-md-2 control-label">
                                    <label>{{msg('callflows.field.placeCall')}}</label>
                                </div>
                            </div>
                            <div class="row form-horizontal">
                                <div class="col-md-3">
                                    <input class="form-control" ng-model="conf.outboundCallLimit" type="text"
                                           name="outboundCallLimit"/>
                                </div>
                                <div class="col-md-3">
                                    <input class="form-control" ng-model="conf.outboundCallRetrySeconds" type="text"
                                           name="outboundCallRetrySeconds"/>
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" ng-model="conf.outboundCallRetryAttempts" type="text"
                                           name="outboundCallRetryAttempts"/>
                                </div>
                                <div class="col-md-2 center-all">
                                    <button class="btn btn-default" ng-click="conf.callAllowed = ! conf.callAllowed"
                                            type="checkbox" name="callAllowed">{{conf.callAllowed ? "Yes" : "No"}}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label" for="servicesMap{{$index}}">{{msg('callflows.field.servicesMap')}}</label>

                        <div class="col-md-8" data-toggle="tooltip" data-html="true" data-placement="top"
                             data-trigger="hover"
                             bs-popover="{{msg('callflows.field.servicesMap.tooltip')}}">
                            <ng-form name="servicesMap{{$index}}">
                                <textarea spellcheck="false" class="form-control" id="servicesMap{{$index}}"
                                          name="services"
                                          rows="3"
                                          ng-pattern="/^(\s*\w*\s*:\s*[\w\.]+\s*)?(,\s*\w*\s*:\s*[\w\.]+\s*)*$/"
                                          ng-model="conf.servicesMapString">
                                </textarea>
                                <span class="form-hint form-hint-bottom"
                                      ng-show="servicesMap{{$index}}.services.$dirty && servicesMap{{$index}}.services.$error.pattern">{{msg('callflows.error.badServices')}}</span>
                            </ng-form>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label">{{msg('callflows.field.testUsers')}}</label>

                        <div class="col-md-9">
                            <label ng-show="! conf.testUsers.length" class="control-label">
                                {{msg('callflows.info.noTestUsers')}}
                            </label>

                            <div ng-repeat="testUser in conf.testUsers">
                                <div class="row test-user-block">
                                    <div class="col-md-3 " data-toggle="tooltip" data-placement="top"
                                         data-trigger="hover"
                                         bs-popover="{{msg('callflows.field.testUsersPhone.tooltip')}}">
                                        <input class="form-control small-mono" ng-model="testUser.phone"
                                               placeholder="{{msg('callflows.field.phone')}}"/>
                                    </div>
                                    <div class="col-md-7" data-toggle="tooltip" data-placement="top"
                                         data-trigger="hover"
                                         bs-popover="{{msg('callflows.field.testUsersURL.tooltip')}}">
                                        <input class="form-control small-mono" ng-model="testUser.outbound"
                                               placeholder="{{msg('callflows.field.outboundURL')}}"/>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-sm btn-danger" ng-click="deleteTestUser(conf, $index);">
                                            <i class="icon-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-offset-3 col-md-9">
                            <button class="btn btn-sm btn-primary" ng-click="addTestUser(conf);">
                                <i class="icon-plus icon-white"></i> {{msg('callflows.btn.addUser')}}
                            </button>
                            <button class="btn btn-sm btn-success" ng-click="deleteTestUsers(conf);">
                                <i class="icon-plus icon-white"></i> {{msg('callflows.btn.deleteUsers')}}
                            </button>
                            <button class="btn btn-sm btn-danger" ng-click="deleteConfig($index)"><i
                                    class="icon-trash"></i> {{msg('callflows.btn.deleteConfig')}}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div>&nbsp;</div>
            <div class="form-inline">
                <button class="btn btn-default" ng-click="reset()">{{msg('callflows.btn.cancel')}}</button>
                <button class="btn btn-primary" ng-disabled="!form.$valid || anyDuplicateNames()" ng-click="submit()">
                    {{msg('callflows.btn.save')}}
                </button>
            </div>
        </div>
    </div>
</form>